# ğŸ¤¯ javaScriptæ•°å­—ä¸¢å¤±ç²¾åº¦é—®é¢˜

æœ€è¿‘åœ¨ä¸€ä¸ªåå°ç®¡ç†é¡¹ç›®ä¸­å‡ºç°ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…ï¼šå½“æˆ‘ä»¬å±•ç¤ºä¸€ä¸ªæœåŠ¡ç«¯ä¼ æ¥çš„è¶…é•¿æ•°å­—æ ‡è¯†æ—¶å‘ç°ï¼Œå±•ç¤ºçš„ç»“æœå’Œæ•°æ®åº“å­˜å‚¨çš„æ•°æ®ä¸ä¸€è‡´ï¼Œå¹¶ä¸”chromeæ§åˆ¶å°Networké¢æ¿ä¸­è·å–çš„æ•°å­—ä¹Ÿå’Œæ•°æ®åº“å­˜å‚¨çš„ä¸ä¸€è‡´ã€‚è¿™æˆ‘å°±å¾ˆçº³é—·å‘ï¼Œè¿˜æœ‰è¿™ç§æ“ä½œï¼Ÿçœ‹æ³¢æˆªå›¾ï¼š
<br><br>
![image.png](./images/number-inaccurate/img-1.png)
<br><br>
ç¢°åˆ°è¿™ç§é—®é¢˜èµ¶ç´§è„‘è¡¥ä¸€ä¸ªæœç´¢å…³é”®è¯ï¼Œç®€å•çš„ç™¾åº¦ä¸€ä¸‹ï¼Œæœå‡ºä¸€å †ç»“æœï¼Œæ’æŸ¥äº†ä¸€ä¸‹ï¼Œç»“æœæ˜¯ä¸ªè€é—®é¢˜äº†ï¼ˆjavaScriptæ•°å­—ç²¾åº¦ä¸¢å¤±é—®é¢˜ï¼‰ã€‚ç»å¸¸çœ‹é¢ç»çš„åŒå­¦åº”è¯¥å¯¹`0.1 + 0.2 !== 0.3` å¾ˆç†Ÿæ‚‰å§ã€‚é‚£æ—¢ç„¶ç¢°åˆ°äº†ï¼Œæˆ‘ä»¬å°±æ¥æ€»ç»“ä¸€æ³¢ï¼Œä»¥é˜²ä¸‹æ¬¡ç¢°åˆ°ç±»ä¼¼çš„é—®é¢˜ä¸€è„¸æ‡µğŸ¤®ã€‚

## JSæ•°å­—ç²¾åº¦ä¸¢å¤±çš„ä¸€äº›å…¸å‹é—®é¢˜

### 1ã€ä¸¤ä¸ªç®€å•çš„æµ®ç‚¹æ•°è¿ç®—
è¿™ç§é—®é¢˜å°±æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ç»å…¸é¢è¯•é¢˜`0.1 + 0.2 !== 0.3` ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ï¼š
```javascript
1 / 3; // 0.3333333333333333
-0.09 - 0.01; // -0.09999999999999999
0.012345 * 0.000001; // 1.2344999999999999e-8
0.000001 / 0.0001; // 0.009999999999999998
```

### 2ã€å¤§æ•´æ•°è¿ç®—
å½“æˆ‘ä»¬çš„æ•´æ•°é•¿åº¦è¶…è¿‡ä¸€å®šæ•°å€¼æ—¶ä¹Ÿä¼šå‡ºç°å¤±å»ç²¾åº¦çš„é—®é¢˜ï¼Œå°±æ¯”å¦‚æˆ‘ä»Šå¤©é‡åˆ°çš„é—®é¢˜ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–æƒ…å†µï¼š
```javascript
9999999999999999 == 10000000000000001; // true
var x = Math.pow(2, 53);
x + 1 === x // true
```

### 3ã€toFixedæ–¹æ³•å››èˆäº”å…¥é”™è¯¯ï¼ˆchromeï¼‰
å½“ä½¿ç”¨toFixedæ–¹æ³•è¿›è¡Œå››èˆäº”å…¥æ—¶ä¹Ÿæœ‰å¯èƒ½å‡ºç°ä¸€äº›ä¸å¯æ€è®®çš„æƒ…å†µï¼ˆå°æ•°ä½å°¾æ•°ä¸º5æ—¶å››èˆäº”å…¥å‡ºé”™ï¼‰ï¼š
```javascript
Number(1.335).toFixed(2); // 1.33
Number(162.295).toFixed(2); // 162.29
```

## JSæ•°å­—ä¸¢å¤±ç²¾åº¦çš„åŸå› 
é€šè¿‡æŸ¥æ‰¾èµ„æ–™æˆ‘ä»¬äº†è§£åˆ°ï¼ŒjavaScriptçš„Numberç±»å‹æ˜¯é‡‡ç”¨æµ®ç‚¹æ•°æ ‡è¯†çš„ï¼Œå¹¶è§„å®šä½¿ç”¨ IEEE 754Q1 æ ‡å‡†çš„åŒç²¾åº¦æµ®ç‚¹æ•°è¡¨ç¤ºã€‚æ‰€ä»¥å½“javaScriptå­˜å‚¨æ•°å€¼æ—¶éœ€è¦å…ˆæŠŠåè¿›åˆ¶æ•°è½¬æ¢æˆäºŒè¿›åˆ¶çš„ç§‘å­¦è®¡æ•°æ³•çš„å½¢å¼ï¼Œç„¶åè®¡ç®—æœºä»¥è‡ªå·±çš„è§„åˆ™ã€ ç¬¦å·ä½ + ï¼ˆæŒ‡æ•°ä½ + æŒ‡æ•°åç§»é‡çš„äºŒè¿›åˆ¶ï¼‰ + å°æ•°ä½ ã€‘Q2  å­˜å‚¨ï¼Œç”±äºå­˜å‚¨æ—¶æœ‰ä½æ•°é™åˆ¶ï¼ˆ64ä½ï¼‰ï¼Œå¹¶ä¸”æŸäº›åè¿›åˆ¶çš„æµ®ç‚¹æ•°åœ¨è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ—¶ä¼šå‡ºç°æ— é™å¾ªç¯ï¼Œé€ æˆäºŒè¿›åˆ¶è¿›è¡Œèˆå…¥æ“ä½œï¼ˆ0èˆ1å…¥ï¼‰ï¼Œå½“å†è½¬æ¢æˆåè¿›åˆ¶æ—¶å°±å‡ºç°äº†è®¡ç®—è¯¯å·®ã€‚
Q1ï¼šIEEE 754æ˜¯ç¾å›½IEEEï¼ˆç”µå™¨åŠç”µå­å·¥ç¨‹å¸ˆåä¼šï¼‰æå‡ºçš„ä¸€ä¸ªä»ç³»ç»Ÿè§’åº¦æ”¯æŒæµ®ç‚¹æ•°çš„è¡¨ç¤ºæ–¹æ³•ï¼Œå½“ä»Šæµè¡Œçš„çš„è®¡ç®—æœºå‡ ä¹éƒ½æ˜¯é‡‡ç”¨äº†è¿™ä¸€æ ‡å‡†ã€‚
IEEE 754è§„å®šäº†ä¸¤ç§åŸºæœ¬æµ®ç‚¹æ ¼å¼ï¼šå•ç²¾åº¦å’ŒåŒç²¾åº¦

   - å•ç²¾åº¦æµ®ç‚¹æ•°åœ¨å†…å­˜ä¸­å 4ä¸ªå­—èŠ‚ã€æœ‰æ•ˆæ•°8ä½ã€è¡¨ç¤ºèŒƒå›´ï¼š-3.40E+38 ~ 3.40E+38
   - åŒç²¾åº¦æµ®ç‚¹æ•°åœ¨å†…å­˜ä¸­å 8ä¸ªå­—èŠ‚ã€æœ‰æ•ˆæ•°å­—16ä½ã€è¡¨ç¤ºèŒƒå›´ï¼š-1.79E+308 ~ 1.79E+308

Q2ï¼šåŒç²¾åº¦æµ®ç‚¹æ•°å›¾è§£
![image.png](./images/number-inaccurate/img-2.png)
> ç¬¦å·ä½ï¼š1 è¡¨ç¤ºæ­£æ•°ã€0è¡¨ç¤ºè´Ÿæ•°
> æŒ‡æ•°ä½ï¼šè§„å®šä½¿ç”¨e+æŒ‡æ•°åç§»é‡ï¼Œå¾—åˆ°çš„ç»“æœå†è½¬åŒ–æˆäºŒè¿›åˆ¶ï¼Œå°±æ˜¯æˆ‘ä»¬çš„æŒ‡æ•°ä½å€¼ã€‚å…¶ä¸­eä¸ºç§‘å­¦è®¡æ•°æ³•ä¸­çš„å¹‚å€¼eï¼Œå¯ä¸ºæ­£æ•°ï¼Œä¹Ÿå¯ä»¥ä¸ºè´Ÿæ•°
> å°æ•°ä½ï¼šè¡¨ç¤ºç²¾ç¡®çš„æ•°å€¼ï¼Œæ€»æ•°52ä½ï¼Œä¸å¤Ÿä½æ•°ç”¨0è¡¥é½ï¼Œå°æ•°ä½å‰æœ‰ä¸€ä¸ªéšè—ä½é»˜è®¤å€¼1ï¼Œæ‰€ä»¥JSä¸­èƒ½ç²¾å‡†è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°ä¸ºMath.pow(2, 53) = 9007199254740992ï¼Œå¯ä»¥ä½¿ç”¨Nuâ€‹mber.MAX_SAFE_INTEGER + 1éªŒè¯

æŒ‡æ•°ä½å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è½¬æ¢æˆä½¿ç”¨çš„æŒ‡æ•°å€¼ï¼š
<br>
<br>
![image.png](./images/number-inaccurate/img-3.png)
ç§‘å­¦è®¡æ•°æ³•å…¬å¼ï¼šX = a * 2e ï¼ˆå…¶ä¸­1 =< a < 2ï¼Œeä¸ºå°æ•°ç‚¹ç§»åŠ¨çš„ä½æ•°ï¼Œæ­£å€¼å³ç§»ï¼Œè´Ÿå€¼å·¦ç§»ï¼‰ã€‚
æŒ‡æ•°åç§»é‡ï¼šæŒ‡æ•°é‡åç§»å…¬å¼Â  Â 
X = 2k-1
> kä¸ºæŒ‡æ•°ä½ä¸ªæ•°ï¼ˆå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒåŒç²¾åº¦æµ®ç‚¹æ•°çš„æŒ‡æ•°ä¸º11ï¼Œå¥—ç”¨å…¬å¼å³X = 211 - 1 = 1023ï¼‰
> æ‰€ä»¥åŒç²¾åº¦æµ®ç‚¹æ•°çš„æŒ‡æ•°åç§»é‡éƒ½ä¸º1023

æ€»ç»“ä¸€ä¸‹åŒç²¾åº¦æµ®ç‚¹æ•°çš„å¤„ç†æ–¹å¼ï¼š

1. å°†ç›®æ ‡æ•°è½¬æ¢æˆäºŒè¿›åˆ¶æ•°
1. å†å°†äºŒè¿›åˆ¶æ•°è½¬ä¸ºç§‘å­¦è®¡æ•°æ³•è¡¨è¾¾å¼å¾—åˆ°åè¿›åˆ¶æŒ‡æ•°ä½å†è½¬åŒ–æˆäºŒè¿›åˆ¶æ•°ï¼Œå»é™¤å› æ•°é¦–ä½å¾—åˆ°å°æ•°ä½
1. æŒ‰ç…§ã€ç¬¦å·ä½ï¼ˆ1ï¼‰ + æŒ‡æ•°ä½ï¼ˆ11ï¼‰ + å°æ•°ä½ï¼ˆ52ï¼‰ã€‘çš„æ–¹å¼æ‹¼æ¥è¿›åˆ¶æ•°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç§‘å­¦è®¡æ•°æ³•çš„å› æ•°aä¸­çš„é¦–ä½1å°±æ˜¯åŒç²¾åº¦æµ®ç‚¹æ•°å°æ•°ä½çš„éšè—ä½æ•°1

---

ä¸¾ä¾‹ï¼š

1. æˆ‘ä»¬å°†16.5è½¬æ¢æˆäºŒè¿›åˆ¶æ•°ï¼ˆåè¿›åˆ¶æ•´æ•°è½¬äºŒè¿›åˆ¶é‡‡ç”¨â€œé™¤2å–ä½™ï¼Œé€†åºæ’åˆ—â€ï¼Œåè¿›åˆ¶å°æ•°è½¬äºŒè¿›åˆ¶å°æ•°é‡‡ç”¨â€œä¹˜2å–æ•´ï¼Œé¡ºåºæ’åˆ—â€ï¼‰ï¼Œå¾—åˆ°1000.1
1. è½¬æ¢æˆç§‘å­¦è®¡æ•°æ³•ï¼š1.0001 *  23 ï¼ŒæŒ‡æ•°ä½ä¸º3 + 1023 = 102610 = 100000000102 ï¼Œå°æ•°ä½ä¸º0001 è¡¥å¤Ÿ52ä½ä¸ºï¼š0001000000000000000000000000000000000000000000000000
1. æŒ‰ç…§åŒç²¾åº¦æµ®ç‚¹æ•°çš„è§„åˆ™è¿›è¡Œæ‹¼æ¥å¾—åˆ°ï¼š1 + 10000000010 + 0001000000000000000000000000000000000000000000000000

é€šè¿‡ä¸Šé¢è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬æ¥æ¨ç®—ä¸€ä¸‹é—®é¢˜çš„åŸå› ï¼š

- `0.1 + 0.2 !== 0.3`

`0.1 >>> 0.0001 1001 1001 1001...ï¼ˆ1001æ— é™å¾ªç¯ï¼‰`
`0.2 >>> 0.0011 0011 0011 0011...ï¼ˆ0011æ— é™å¾ªç¯ï¼‰`
`0.1 + 0.2 >> 0.0100 1100 1100 1100...ï¼ˆ1100æ— é™å¾ªç¯ï¼‰`
è½¬æ¢æˆåè¿›åˆ¶åå°±å˜æˆäº†0.30000000000000004

- å¤§æ•´æ•°è¿ç®—å¤±å‡†æ˜¯å› ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°èƒ½è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°ä¸ºMath.pow(2, 53) = 9007199254740992ï¼Œå½“è¶…è¿‡è¿™ä¸ªæ•°æ—¶å°±ä¼šå‡ºç°ä¸¢å¤±ç²¾åº¦çš„æƒ…å†µã€‚
- toFixed()å¯¹äºå°æ•°æœ€åä¸€ä½ä¸º5æ—¶ï¼Œè¿›ä½ä¸æ­£ç¡®çš„é—®é¢˜æ˜¯ï¼Œå› ä¸ºå½“æœ€åä¸€ä½ä¸º5æ—¶ï¼Œå¯èƒ½å®é™…çš„æ•°å°äº5ï¼Œæ‹¿`1.005`ä¸¾ä¾‹ï¼Œ`1.005.toPrecision(21) = ``1.00499999999999989342` ã€‚åé¢çš„å€¼åœ¨å››èˆäº”å…¥æ—¶è¢«èˆå»äº†ï¼Œæ‰€ä»¥é€ æˆäº†è¿™æ ·çš„é”™è¯¯




## è§£å†³æ–¹æ¡ˆ
å¯¹äºæ•´æ•°ï¼ŒJSå‡ºé”™åªå‘ç”Ÿåœ¨å¤§æ•´æ•°è¿ç®—ä¸¢å¤±ç²¾åº¦ï¼Œåªè¦è¿ç®—ç»“æœä¸è¶…è¿‡Math.pow(2, 53)ä¸€èˆ¬ä¸ä¼šå‡ºç°ä¸¢å¤±ç²¾åº¦çš„æƒ…å†µã€‚å¦‚æœè¶…å‡ºäº†æ•´æ•°è¾¹ç•Œï¼Œæˆ‘ä»¬ç»™å‡ºæé†’
å¯¹äºå°æ•°ï¼Œå‡ºç°é—®é¢˜çš„æ¦‚ç‡æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸æŠŠå°æ•°è½¬å˜æˆæ•´æ•°åè¿›è¡Œè¿ç®—ï¼Œç„¶åå°†è¿ç®—ç»“æœé™¤ä»¥æ‰©å¤§çš„å€æ•°å¾—å‡ºç»“æœ
è€Œå¯¹äºæ•°æ®çš„ç²¾å‡†å±•ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæ–¹æ³•æ¥è¿›è¡Œå¤„ç†ï¼š
```javascript
function strip(num, precision = 12) {	
	return +parseFloat(Number(num).toPrecision(precision));
};
strip(1.40000000000001); // 1.4
```
å°æ•°è¿ç®—çš„æ–¹æ³•é‡‡ç”¨æ‰©ç¼©æ³•ï¼Œè§£å†³æ€è·¯å¯ä»¥é€šè¿‡å°æ•°ç‚¹çš„ä½ç½®æ¥è®¡ç®—éœ€è¦æ‰©å¤§çš„å€æ•°ï¼Œä¸¤ä¸ªæ•°çš„å€æ•°å–è¾ƒå¤§çš„é‚£ä¸ªï¼Œè¿ç®—ä»¥åï¼Œå†é™¤ä»¥å€æ•°å¾—å‡ºç»“æœï¼Œæ ¹æ®è¿™ä¸ªæ€è·¯æˆ‘ä»¬æ¥æ•´ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼š
```javascript
/*
 * @method strip æ­£ç¡®è¡¨ç¤ºæ•°æ®çš„å€¼
 * @param {number} num å¤„ç†å€¼
 * @param {precision} å¤„ç†ç²¾åº¦
 */
function strip (num, precision = 12) {
	return +parseFloat(Number(num).toPrecision(precision));
};

/*
 * @method digitLength è·å–æœ‰æ•ˆå€¼çš„é•¿åº¦(å…¼å®¹ç§‘å­¦è®¡æ•°æ³•å–å€¼)
 * @param {number} num å¤„ç†å€¼
 */
function digitLength (num) {
	const eSplit = num.toString().split(/[eE]/i);
  const len = (eSplit[0].split('.')[1] || '').length - +(eSplit[1] || 0);
  return len > 0 ? len : 0;
};

/*
 * @method floatToInt æŠŠå°æ•°æ‰©å¤§æˆæ•´æ•°ï¼Œæ”¯æŒç§‘å­¦è®¡æ•°æ³•
 * @param {number} num å¤„ç†å€¼
 */
function floatToInt (num) {
	if (num.toString().indexOf('e') === -1) {
  	return Number(num.toString().replace('.', ''));
  }
  const digLen = digitLength(num);
  return digLen > 0 ? (Number(num) * Math.pow(10, digLen)) : Number(num);
};

/*
 * @method checkBoundary æ£€æŸ¥æ•°å­—æ˜¯å¦è¶Šç•Œï¼Œå¦‚æœè¶Šç•Œç»™å‡ºæç¤º
 * @param {Number} num å¤„ç†å€¼
 */
function checkBoundary (num) {
	if (num > Number.MAX_SAFE_INTERGER || num < Number.MIN_SAFE_INTERGER) {
  	console.error(num + 'å·²ç»è¶…è¿‡æ•°å€¼è¿ç®—çš„æé™ï¼Œå½“è¿›è¡Œè¿ç®—æ—¶æœ‰ä¸¢å¤±ç²¾åº¦çš„é£é™©ï¼');
  }
};

/*
 * @method multiple ç²¾å‡†ä¹˜æ³•
 * @param {Number} num1 è¿ç®—å‚æ•°1
 * @param {Number} num2 è¿ç®—å‚æ•°2
 */
function multiple (num1, num2) {
	const int1 = floatToInt(num1);
  const int2 = floatToInt(num2);
  const baseNum = digitLength(num1) + digitLength(num2);
  const products = int1 * int2;
  
  checkBoundary(products);
  
  return products / Math.pow(10, baseNum);
};

/*
 * @method add ç²¾å‡†åŠ æ³•
 * @param {Number} num1 è¿ç®—å‚æ•°1
 * @param {Number} num2 è¿ç®—å‚æ•°2
 */
function add (num1, num2) {
  const maxBase = Math.pow(10, Math.max(digitLength(num1), digitLength(num2)));
  return (multiple(num1, maxBase) + multiple(num2, maxBase)) / maxBase;
};

/*
 * @method subtract ç²¾å‡†å‡æ³•
 * @param {Number} num1 è¿ç®—å‚æ•°1
 * @param {Number} num2 è¿ç®—å‚æ•°2
 */
function subtract (num1, num2) {
  const maxBase = Math.pow(10, Math.max(digitLength(num1), digitLength(num2)));
  return (multiple(num1, maxBase) - multiple(num2, maxBase)) / maxBase;
};

/*
 * @method devide ç²¾å‡†é™¤æ³•
 * @param {Number} num1 è¿ç®—å‚æ•°1
 * @param {Number} num2 è¿ç®—å‚æ•°2
 */
function devide (num1, num2) {
	const int1 = floatToInt(num1);
  const int2 = floatToInt(num2);
  
  checkBoundary(int1);
  checkBoundary(int2);
  
  return multiple(int1 / int2, strip(Math.pow(10, digitLength(num2) - digitLength(num1))));
};

/*
 * @method round ç²¾å‡†å››èˆäº”å…¥
 * @param {Number} num å¤„ç†å€¼
 * @param {Number} ratio å–å€¼ç²¾åº¦
 */
function round (num, ratio) {
	const base = Math.pow(10, ratio);
  return devide(Math.round(multiple(num, base)), base);
};
```

## å¼•ç”¨
ã€1ã€‘ å¤å…°ç²¾  [JavaScriptæ•°å­—ç²¾åº¦ä¸¢å¤±é—®é¢˜æ€»ç»“](https://www.cnblogs.com/goloving/p/7712742.html)
<br>
ã€2ã€‘ è‡ªç”±çš„å›šå¾’ [jsç²¾åº¦ä¸¢å¤±é—®é¢˜-çœ‹è¿™ç¯‡æ–‡ç« å°±å¤Ÿäº†(é€šä¿—æ˜“æ‡‚)](https://zhuanlan.zhihu.com/p/100353781)
<br>
ã€3ã€‘ ksfkf [IEEE 754æ ‡å‡†](https://www.jianshu.com/p/7c636d8f18d5)
<br>
ã€4ã€‘ èœé¸Ÿæ•™ç¨‹ [åè¿›åˆ¶æ•°è½¬æ¢æˆäºŒè¿›åˆ¶æ•°](https://www.runoob.com/w3cnote/decimal-decimals-are-converted-to-binary-fractions.html)
<br>
ã€5ã€‘ nefe [number-precision](https://github.com/nefe/number-precision/blob/master/src/index.ts)
